<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Plateforme Examens ‚Äì Vue Doyen</title>
<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#004080;color:#fff;padding:15px;display:flex;justify-content:space-between}
.container{display:flex}
aside{width:230px;background:#ddd;padding:10px}
aside ul{list-style:none;padding:0}
aside li{padding:10px;margin:5px 0;background:#004080;color:white;cursor:pointer;border-radius:5px}
aside li:hover{background:#0066cc}
main{flex:1;padding:20px}
section{display:none;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 5px rgba(0,0,0,.2)}
section.active{display:block}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
.status-valid{color:green;font-weight:bold}
.status-wait{color:orange;font-weight:bold}
.status-reject{color:red;font-weight:bold}
.actions button{margin:5px;padding:6px 12px;border:none;border-radius:5px;cursor:pointer}
.btn-fix{background:#ffc107}
.btn-validate{background:#28a745;color:white}
.btn-reject{background:#dc3545;color:white}
h4,h5,h6{margin:5px 0;cursor:pointer;}
</style>
</head>
<body>

<header>
<h2>Facult√© des Sciences ‚Äì Examens</h2>
<div>Doyen  </div>
</header>

<div class="container">
<aside>
  <ul>
    <li onclick="showSection('edt')">üìÖ Emplois du temps</li>
    <li onclick="showSection('vueGlobale')">üìä Vue strat√©gique</li>
    <li onclick="showSection('contraintes')">‚ö†Ô∏è Contraintes & conflits</li>
    <li onclick="showSection('kpis')">üìà KPIs acad√©miques</li>
    <!-- Nouveau bouton pour le taux de conflits -->
    <li onclick="showSection('tauxConflitsSection')">üö® Taux de conflits</li>
    <a href="../logout.php" class="btn btn-outline-danger w-100 mt-5"><i class="bi bi-box-arrow-left"></i> D√©connexion</a>
    
    
  </ul>
  
</aside>

<main>
 
  <section id="vueGlobale">
    <h3>üè´ Occupation globale </h3>
    <div id="statsGlobales"></div>
  </section>
  
  <section id="contraintes">
    <h3>‚ö†Ô∏è Contraintes et conflits</h3>
    <table id="tableConflits">
      <thead>
        <tr>
          <th>Type</th>
          <th>D√©partement / √âtudiant / Prof</th>
          <th>D√©tail</th>
          <th>Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5">Chargement...</td></tr>
      </tbody>
    </table>
  </section>
  
  
  <section id="kpis">
    <h3>üìä KPIs Acad√©miques </h3>
    <table id="tableKPIs">
      <thead>
        <tr>
          <th>D√©partement</th>
          <th>Heures profs (total)</th>
          <th>Nombre d'examens</th>
          <th>Salles utilis√©es / total</th>
          <th>% Utilisation Salles</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5">Chargement...</td></tr>
      </tbody>
    </table>
  </section>
  
  
  <section id="tauxConflitsSection">
    <h3>üìà Taux de conflits par d√©partement</h3>
    <div id="tauxConflitsContainer">
      <table id="tableTauxConflits">
        <thead>
          <tr>
            <th>D√©partement</th>
            <th>Nombre de conflits</th>
            <th>Nombre d'examens</th>
            <th>Taux de conflits</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </section>
  
<section id="edt" class="active">
<h3>Emplois du temps des examens</h3>
<div id="departementsContainer"></div>
</section>
</main>
</div>

<script>


function chargerEDT(){
  fetch("get_examens.php")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("departementsContainer");
      container.innerHTML = "";
      const deps = {};

      // Organiser les donn√©es par d√©partement / niveau / sp√©cialit√©
      data.forEach(e => {
        if(!deps[e.departement]) deps[e.departement]={};
        if(!deps[e.departement][e.niveau]) deps[e.departement][e.niveau]={};
        if(!deps[e.departement][e.niveau][e.specialite]) deps[e.departement][e.niveau][e.specialite]=[];
        deps[e.departement][e.niveau][e.specialite].push(e);
      });

      for(const dep in deps){
        let depHTML = `<h4 onclick="toggleVisibility('dep-${dep}')">üìÇ ${dep}</h4>`;
        depHTML += `<div id="dep-${dep}" style="display:none;padding-left:20px;">`;
        for(const niv in deps[dep]){
          depHTML += `<h5 onclick="toggleVisibility('niv-${dep}-${niv}')" style="color:#0066cc;">üéì ${niv}</h5>`;
          depHTML += `<div id="niv-${dep}-${niv}" style="display:none;padding-left:20px;">`;
          for(const spec in deps[dep][niv]){
            depHTML += `<h6 onclick="toggleVisibility('spec-${dep}-${niv}-${spec}')" style="color:#008080;">üóÇÔ∏è ${spec}</h6>`;
            depHTML += `<div id="spec-${dep}-${niv}-${spec}" style="display:none;padding-left:20px;">`;

            // Table des examens
            depHTML += `<table>
              <thead>
                <tr>
                  <th>Module</th>
                  <th>Date</th>
                  <th>Salle</th>
                  <th>Surveillant</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>`;
            deps[dep][niv][spec].forEach(e=>{
              let cls = e.statut==="VALIDE"?"status-valid":e.statut==="REJETE"?"status-reject":"status-wait";
              let txt = e.statut==="VALIDE"?"üü¢ Valid√©":e.statut==="REJETE"?"üî¥ Rejet√©":"üü° En attente";
              depHTML += `<tr>
                <td>${e.module||'-'}</td>
                <td>${e.date_examen||'-'}</td>
                <td>${e.salle||'-'}</td>
                <td>${e.surveillant||'-'}</td>
                <td class="${cls}">${txt}</td>
              </tr>`;
            });
            depHTML += `</tbody></table>`;

            // Boutons
            depHTML += `<div class="actions">
              <button onclick="setStatusSpecialite('${dep}','${niv}','${spec}','wait')" class="btn-fix">üü° Ajustement</button>
              <button onclick="setStatusSpecialite('${dep}','${niv}','${spec}','valid')" class="btn-validate">‚úÖ Valider</button>
              <button onclick="setStatusSpecialite('${dep}','${niv}','${spec}','reject')" class="btn-reject">‚ùå Rejeter</button>
            </div>`;

            depHTML += `</div>`;
          }
          depHTML += `</div>`;
        }
        depHTML += `</div>`;
        container.innerHTML += depHTML;
      }
    })
    .catch(err=>console.error("Erreur chargement EDT:",err));
}

function toggleVisibility(id){
  const el=document.getElementById(id);
  el.style.display = (el.style.display==='none')?'block':'none';
}

function setStatusSpecialite(dep,niv,spec,type){
  let statut = type==='valid'?'VALIDE':type==='reject'?'REJETE':'EN_ATTENTE';
  fetch("update_status_specialite.php",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`departement=${encodeURIComponent(dep)}&niveau=${encodeURIComponent(niv)}&specialite=${encodeURIComponent(spec)}&statut=${encodeURIComponent(statut)}`
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      chargerEDT();
      alert(`‚úî Statut appliqu√© pour ${niv} - ${spec}`);
    } else {
      alert("‚ùå Erreur: "+(data.msg||""));
    }
  });
}

document.addEventListener("DOMContentLoaded",chargerEDT);
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id === "vueGlobale") chargerStats();
  if(id === "contraintes") chargerConflits();
  if(id === "kpis") chargerKPIs();
  if(id === "tauxConflitsSection") chargerTauxConflits();

}

function showSection(id){
  // cacher toutes les sections
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));

  // afficher la section demand√©e
  document.getElementById(id).classList.add("active");

  // charger les donn√©es selon la section
  if(id === "vueGlobale") chargerStats();
  if(id === "contraintes") chargerConflits();
  if(id === "kpis") chargerKPIs();
  if(id === "tauxConflitsSection") chargerTauxConflits();
}

function chargerStats(){
  fetch("stats_globales.php")
  .then(res=>res.json())
  .then(data=>{
    let html = `<table>
      <thead>
        <tr>
          <th>D√©partement</th>
          <th>Amphis utilis√©es / total</th>
          <th>% Occupation Amphis</th>
          <th>Salles utilis√©es / total</th>
          <th>% Occupation Salles</th>
          <th>Labs utilis√©es / total</th>
          <th>% Occupation Labs</th>
        </tr>
      </thead>
      <tbody>`;
    
    data.forEach(d=>{
      let occ_amphi = d.total_amphi>0 ? ((d.salles_Amphi||0)/d.total_amphi*100).toFixed(1) : 0;
      let occ_salle = d.total_salle>0 ? ((d.salles_Salle||0)/d.total_salle*100).toFixed(1) : 0;
      let occ_labo  = d.total_labo>0 ? ((d.salles_Labo||0)/d.total_labo*100).toFixed(1) : 0;

      html += `<tr>
        <td>${d.nom}</td>
        <td>${d.salles_Amphi||0} / ${d.total_amphi}</td>
        <td>${occ_amphi}%</td>
        <td>${d.salles_Salle||0} / ${d.total_salle}</td>
        <td>${occ_salle}%</td>
        <td>${d.salles_Labo||0} / ${d.total_labo}</td>
        <td>${occ_labo}%</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById("statsGlobales").innerHTML = html;
  })
  .catch(err=>{
    console.error("Erreur stats:", err);
    document.getElementById("statsGlobales").innerHTML = "‚ö†Ô∏è Impossible de charger les stats";
  });
}


function chargerConflits(){
  fetch("detecter_conflits.php")
    .then(res => res.json())
    .then(data => {
      let tbody = document.querySelector("#tableConflits tbody");
      tbody.innerHTML = "";

      if(data.length === 0){
        tbody.innerHTML = `<tr><td colspan="5">‚úÖ Aucun conflit d√©tect√©</td></tr>`;
        return;
      }

      data.forEach(c=>{
        let color = c.status === 'danger' ? '#f8d7da' :
                    c.status === 'warning' ? '#fff3cd' : '#d1e7dd';

        tbody.innerHTML += `<tr style="background-color:${color}">
          <td>${c.type}</td>
          <td>${c.nom}</td>
          <td>${c.detail}</td>
          <td>${c.date}</td>
          <td>${c.status==='danger' ? '‚ùå Critique' : '‚ö†Ô∏è Attention'}</td>
        </tr>`;
      });
    })
    .catch(err=>{
      console.error("Erreur chargement conflits:", err);
      document.querySelector("#tableConflits tbody").innerHTML = "<tr><td colspan='5'>‚ö†Ô∏è Impossible de charger les conflits</td></tr>";
    });
}

function chargerKPIs(){
  fetch("kpis.php")
  .then(res=>res.json())
  .then(data=>{
    let tbody = document.querySelector("#tableKPIs tbody");
    tbody.innerHTML = "";

    data.forEach(d=>{
      let taux = d.total_salles > 0 ? ((d.salles_utilisees/d.total_salles)*100).toFixed(1) : 0;
      tbody.innerHTML += `<tr>
        <td>${d.nom}</td>
        <td>${d.heures_profs}</td>
        <td>${d.examens}</td>
        <td>${d.salles_utilisees} / ${d.total_salles}</td>
        <td>${taux}%</td>
      </tr>`;
    });

    if(data.length===0){
      tbody.innerHTML = "<tr><td colspan='5'>‚ö†Ô∏è Aucun KPI disponible</td></tr>";
    }
  })
  .catch(err=>{
    console.error("Erreur chargement KPIs:",err);
    document.querySelector("#tableKPIs tbody").innerHTML = "<tr><td colspan='5'>‚ö†Ô∏è Impossible de charger les KPIs</td></tr>";
  });
}
function chargerTauxConflits(){
  fetch("taux_conflits.php")
    .then(res=>res.json())
    .then(data=>{
      let tbody = document.querySelector("#tableTauxConflits tbody");
      tbody.innerHTML = "";

      if(data.length === 0){
        tbody.innerHTML = "<tr><td colspan='4'>‚ö†Ô∏è Aucun conflit disponible</td></tr>";
        return;
      }

      data.forEach(d=>{
        let color = d.taux >= 50 ? '#f8d7da' : d.taux >= 20 ? '#fff3cd' : '#d1e7dd';
        tbody.innerHTML += `<tr style="background-color:${color}">
          <td>${d.nom}</td>
          <td>${d.conflits}</td>
          <td>${d.examens}</td>
          <td>${d.taux}%</td>
        </tr>`;
      });
    })
    .catch(err=>{
      console.error("Erreur chargement taux conflits:",err);
      document.querySelector("#tableTauxConflits tbody").innerHTML = "<tr><td colspan='4'>‚ö†Ô∏è Impossible de charger les taux</td></tr>";
    });
}


</script>


</body>
</html>
