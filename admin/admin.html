<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin - Gestion Totale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar { min-height: 100vh; background: #1a1d20; color: white; position: fixed; width: 250px; z-index: 100; }
        .main { margin-left: 260px; padding: 20px; }
        .section { display: none; }
        .active { display: block; }
        .card-dash { border: none; border-radius: 10px; color: white; padding: 20px; transition: 0.3s; }
        .card-dash:hover { transform: translateY(-5px); }
        .table-responsive { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
    </style>
</head>
<body class="bg-light">

<div class="sidebar p-3 shadow">
    <h4 class="text-center text-warning fw-bold">ADMIN PANEL</h4><hr>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('dash')"><i class="bi bi-speedometer2 me-2"></i> Dashboard</button>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('users')"><i class="bi bi-people me-2"></i> Utilisateurs</button>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('depts')"><i class="bi bi-diagram-3 me-2"></i> Départements</button>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('rooms')"><i class="bi bi-building me-2"></i> Salles</button>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('forms')"><i class="bi bi-mortarboard me-2"></i> Formations</button>
    <button class="btn btn-dark w-100 text-start mb-2" onclick="show('mods')"><i class="bi bi-book me-2"></i> Modules</button>
    <button class="btn btn-warning w-100 text-start mb-2 py-2 fw-bold text-dark shadow-sm" onclick="show('exams')">
        <i class="bi bi-calendar-check me-2"></i> PLANIFICATION
    </button>
    <a href="logout.php" class="btn btn-outline-danger w-100 mt-5"><i class="bi bi-box-arrow-left"></i> Déconnexion</a>
</div>

<div class="main">
    
    <div id="dash" class="section active">
        <h3 class="mb-4">Vue d'ensemble</h3>
        <div class="row g-3">
            <div class="col-md-3"><div class="card-dash bg-primary"><h6>Utilisateurs</h6><h2><?= $total_users ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-success"><h6>Professeurs</h6><h2><?= $total_profs ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-info"><h6>Étudiants</h6><h2><?= $total_etud ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-info"><h6>Chef departement</h6><h2><?= $total_chef ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-warning text-dark"><h6>Salles</h6><h2><?= $total_rooms ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-warning text-dark"><h6>Modules</h6><h2><?= $total_mods ?></h2></div></div>
            <div class="col-md-3"><div class="card-dash bg-warning text-dark"><h6>Formations</h6><h2><?= $total_form ?></h2></div></div>
        </div>
    </div>

    <div id="users" class="section">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <h3>Gestion des Utilisateurs</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">+ Ajouter</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark"><tr><th>Nom</th><th>Prénom</th><th>Username</th><th>Passward</th><th>Rôle</th><th>Departement</th><th>Formation</th><th>Actions</th></tr></thead>
                <tbody><?php foreach($users as $u): ?><tr>
                    <td><?= $u['nom'] ?></td><td><?= $u['prenom'] ?></td><td><?= $u['username'] ?></td>
                    <td><span class="badge bg-secondary"><?= $u['password'] ?></span></td>
                    <td><span class="badge bg-secondary"><?= $u['role'] ?></span></td>
                    <td><?= $u['dept_nom'] ?? 'Aucun'?></td><td><?= $u['formation_nom'] ?? 'Aucun' ?></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick='editUser(<?= json_encode($u) ?>)'><i class="bi bi-pencil"></i></button>
                        <a href="admin.php?del_user=<?= $u['id'] ?>" class="btn btn-sm btn-danger" onclick="return confirm('Supprimer cet utilisateur ?')"><i class="bi bi-trash"></i></a>
                    </td>
                </tr><?php endforeach; ?></tbody>
            </table>
        </div>
    </div>

    <div id="depts" class="section">
        <div class="d-flex justify-content-between mb-3 align-items-center"><h3>Départements</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeptModal">+ Nouveau</button></div>
        <div class="table-responsive">
            <table class="table"><thead><tr><th>Nom du Département</th><th>Actions</th></tr></thead>
            <tbody><?php foreach($depts as $d): ?><tr><td><?= $d['nom'] ?></td><td>
                <button class="btn btn-sm btn-warning" onclick='editDept(<?= json_encode($d) ?>)'><i class="bi bi-pencil"></i></button>
                <a href="admin.php?del_dept=<?= $d['id'] ?>" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
            </td></tr><?php endforeach; ?></tbody></table>
        </div>
    </div>

    <div id="rooms" class="section">
        <div class="d-flex justify-content-between mb-3"><h3>Salles d'examen</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal">+ Nouvelle</button></div>
        <div class="table-responsive">
            <table class="table"><thead><tr><th>Nom</th><th>Capacité</th><th>Type</th><th>Actions</th></tr></thead>
            <tbody><?php foreach($rooms as $r): ?><tr><td><?= $r['nom'] ?></td><td><?= $r['capacite'] ?> places</td><td><?= $r['type'] ?></td><td>
                <button class="btn btn-sm btn-warning" onclick='editRoom(<?= json_encode($r) ?>)'><i class="bi bi-pencil"></i></button>
                <a href="admin.php?del_room=<?= $r['id'] ?>" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
            </td></tr><?php endforeach; ?></tbody></table>
        </div>
    </div>

    <div id="forms" class="section">
        <div class="d-flex justify-content-between mb-3"><h3>Formations</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFormModal">+ Nouvelle</button></div>
        <div class="table-responsive">
            <table class="table"><thead><tr><th>Formation</th><th>Département</th><th>Actions</th></tr></thead>
            <tbody><?php foreach($forms as $f): ?><tr><td><?= $f['nom'] ?></td><td><?= $f['dept_nom'] ?></td><td>
                <button class="btn btn-sm btn-warning" onclick='editForm(<?= json_encode($f) ?>)'><i class="bi bi-pencil"></i></button>
                <a href="admin.php?del_form=<?= $f['id'] ?>" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
            </td></tr><?php endforeach; ?></tbody></table>
        </div>
    </div>

    <div id="mods" class="section">
        <div class="d-flex justify-content-between mb-3"><h3>Modules</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModModal">+ Nouveau</button></div>
        <div class="table-responsive">
            <table class="table"><thead><tr><th>Module</th><th>Formation</th><th>Actions</th></tr></thead>
            <tbody><?php foreach($mods as $m): ?><tr><td><?= $m['nom'] ?></td><td><?= $m['form_nom'] ?></td><td>
                <button class="btn btn-sm btn-warning" onclick='editMod(<?= json_encode($m) ?>)'><i class="bi bi-pencil"></i></button>
                <a href="admin.php?del_mod=<?= $m['id'] ?>" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
            </td></tr><?php endforeach; ?></tbody></table>
        </div>
    </div>

    <div id="exams" class="section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-calendar-event text-warning"></i> Calendrier des Examens</h3>
            <button class="btn btn-warning fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#addExamModal">+ Nouvelle Planification</button>
        </div>

        <div class="card shadow-sm mb-4 border-warning">
            <div class="card-body bg-white">
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">Filtrer par formation :</label>
                        <select id="filterFormation" class="form-select border-warning" onchange="filterExamsByFormation()">
                            <option value="all">-- Toutes les formations --</option>
                            <?php foreach($forms as $f): ?>
                                <option value="<?= $f['id'] ?>" data-nom="<?= $f['nom'] ?>"><?= $f['nom'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button onclick="printSpecificFormation()" class="btn btn-danger w-100 fw-bold">
                            <i class="bi bi-file-earmark-pdf"></i> Imprimer le PDF (Filtre)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table align-middle" id="tableExams">
                <thead class="table-warning">
                    <tr>
                        <th>Date & Heure</th><th>Formation</th><th>Module</th><th>Salle</th><th>Professeur</th><th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach($exams as $e): ?>
                    <tr class="exam-row" data-formation="<?= $e['form_nom'] ?>">
                        <td><strong><?= date('d/m/Y', strtotime($e['date_examen'])) ?></strong> à <?= $e['heure_debut'] ?></td>
                        <td><span class="badge bg-info text-dark"><?= $e['form_nom'] ?></span></td>
                        <td><strong><?= $e['mod_nom'] ?></strong></td>
                        <td><?= $e['salle_nom'] ?></td>
                        <td><?= $e['prof_nom'] ?></td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" onclick='editExam(<?= json_encode($e) ?>)'><i class="bi bi-pencil"></i></button>
                            <a href="admin.php?del_exam=<?= $e['id'] ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Annuler cet examen ?')"><i class="bi bi-trash"></i></a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><form class="modal-content" method="POST">
    <div class="modal-header bg-primary text-white"><h5>Nouvel Utilisateur</h5></div>
    <div class="modal-body">
        <input type="text" name="nom" placeholder="Nom" class="form-control mb-2" required>
        <input type="text" name="prenom" placeholder="Prénom" class="form-control mb-2" required>
        <input type="text" name="user" placeholder="Username" class="form-control mb-2" required>
        <input type="password" name="password" placeholder="Mot de passe" class="form-control mb-2" required>
        <select name="role" class="form-select mb-2">
            <option value="etudiant">Étudiant</option>
            <option value="professeur">Professeur</option>
            <option value="chef_dep">Chef de Département</option>
        </select>
        <label>Département :</label>
        <select name="dept_id" class="form-select mb-2"><?php foreach($depts as $d): ?><option value="<?= $d['id'] ?>"><?= $d['nom'] ?></option><?php endforeach; ?></select>
        <label>Formation (si étudiant) :</label>
        <select name="formation_id" class="form-select"><?php foreach($forms as $f): ?><option value="<?= $f['id'] ?>"><?= $f['nom'] ?></option><?php endforeach; ?></select>
    </div>
    <div class="modal-footer"><button type="submit" name="add_user" class="btn btn-primary w-100">Ajouter</button></div>
</form></div></div>

<div class="modal fade" id="addExamModal" tabindex="-1"><div class="modal-dialog"><form class="modal-content" method="POST">
    <div class="modal-header bg-warning"><h5>Nouvelle Planification d'Examen</h5></div>
    <div class="modal-body">
        <label>Module :</label>
        <select name="module_id" class="form-select mb-2" required>
            <?php foreach($mods as $m): ?><option value="<?= $m['id'] ?>"><?= $m['nom'] ?> (<?= $m['form_nom'] ?>)</option><?php endforeach; ?>
        </select>
        <label>Salle :</label>
        <select name="salle_id" class="form-select mb-2" required>
            <?php foreach($rooms as $r): ?><option value="<?= $r['id'] ?>"><?= $r['nom'] ?> (<?= $r['capacite'] ?> pl)</option><?php endforeach; ?>
        </select>
        <label>Professeur Surveillant :</label>
        <select name="prof_id" class="form-select mb-2" required>
            <?php foreach($profs as $p): ?><option value="<?= $p['id'] ?>"><?= $p['nom'] ?> <?= $p['prenom'] ?></option><?php endforeach; ?>
        </select>
        <div class="row">
            <div class="col-6"><label>Date :</label><input type="date" name="date_examen" class="form-control" required></div>
            <div class="col-6"><label>Heure :</label><input type="time" name="heure_debut" class="form-control" required></div>
        </div>
        <input type="hidden" name="duree_minutes" value="90">
    </div>
    <div class="modal-footer"><button type="submit" name="add_exam" class="btn btn-warning w-100 fw-bold">Enregistrer l'Examen</button></div>
</form></div></div>

<div class="modal fade" id="editExamModal" tabindex="-1"><div class="modal-dialog"><form class="modal-content" method="POST">
    <input type="hidden" name="id" id="ee_id">
    <div class="modal-header bg-warning"><h5>Modifier l'Examen</h5></div>
    <div class="modal-body">
        <label>Module :</label><select name="module_id" id="ee_module" class="form-select mb-2"><?php foreach($mods as $m): ?><option value="<?= $m['id'] ?>"><?= $m['nom'] ?></option><?php endforeach; ?></select>
        <div class="row">
            <div class="col-6"><label>Date :</label><input type="date" name="date_examen" id="ee_date" class="form-control"></div>
            <div class="col-6"><label>Heure :</label><input type="time" name="heure_debut" id="ee_heure" class="form-control"></div>
        </div>
    </div>
    <div class="modal-footer"><button type="submit" name="update_exam" class="btn btn-warning w-100">Enregistrer les modifications</button></div>
</form></div></div>

<script>
    // 1. Navigation entre les onglets
    function show(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) { 
            target.classList.add('active'); 
            window.location.hash = id; 
        }
    }

    // 2. Filtrage visuel dynamique du tableau Planification
    function filterExamsByFormation() {
        let select = document.getElementById('filterFormation');
        let selectedNom = select.options[select.selectedIndex].getAttribute('data-nom');
        let rows = document.querySelectorAll('.exam-row');

        rows.forEach(row => {
            if (select.value === "all") {
                row.style.display = "";
            } else {
                row.style.display = (row.getAttribute('data-formation') === selectedNom) ? "" : "none";
            }
        });
    }

    // 3. Impression PDF ciblée
    function printSpecificFormation() {
        let formationId = document.getElementById('filterFormation').value;
        if (formationId === "all") {
            window.open('export_fpdf.php', '_blank');
        } else {
            window.open('export_fpdf.php?formation_id=' + formationId, '_blank');
        }
    }

    // 4. Fonctions pour ouvrir les modaux d'édition avec les données
    function editExam(e) {
        document.getElementById('ee_id').value = e.id;
        document.getElementById('ee_module').value = e.module_id;
        document.getElementById('ee_date').value = e.date_examen;
        document.getElementById('ee_heure').value = e.heure_debut;
        new bootstrap.Modal(document.getElementById('editExamModal')).show();
    }

    // Garder l'onglet actif au rechargement
    window.onload = function() {
        let hash = window.location.hash.replace('#', '');
        show(hash ? hash : 'dash');
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>